<?php

include 'php/db.php'; // $mysqli 변수 포함

$ip = $_SESSION['id']; // 사용자의 IP주소 가져오기
$article_id = $_GET['idx']; // 게시글 아이디
$service_code = $_GET['getLikedByCode'];

if(!empty($article_id)) {
    $sql1 = "SELECT * from tlike WHERE service_code = '$article_id' AND liked_ip = '$ip'";
    $res1 = mysqli_num_rows($db->query($sql1)); // sql 의 행 갯수를 가져옴 

    if($res1 == 0) {
        // 좋아요 기록이 없는 경우 -> 좋아요 등록
        $sql2 = "INSERT into tlike VALUES(0, '$article_id', '$ip', 1, sysdate())";
        $res2 = $db->query($sql2);

        // 게시판 테이블 업데이트
        $sql3 = "UPDATE board SET likey=(likey + 1) WHERE idx = $article_id";
        $res3 = $db->query($sql3);

        echo "
        <script type='text/javascript'>alert('추천하였습니다.');</script>
        <meta http-equiv='refresh' content='0 url=/community.php' />
        ";
    } else {
        // 이미 좋아요를 누른 경우 -> 좋아요 취소
        $sql2 = "DELETE from tlike WHERE service_code = '$article_id' AND liked_ip = '$ip'";
        $res2 = $db->query($sql2);
        
        // 게시판 테이블 업데이트
        $sql3 = "UPDATE board SET likey = (likey - 1) WHERE idx = $article_id";
        $res3 = $db->query($sql3);
        echo "
        <script type='text/javascript'>alert('취소하였습니다.');</script>
        <meta http-equiv='refresh' content='0 url=/community.php' />
        ";
    }
} 
?>